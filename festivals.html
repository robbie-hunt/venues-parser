<!DOCTYPE html>
<html>
<head>
  <title>Festival Parser</title>
</head>
<body>
  <h1>Festival Information Parser</h1>

  <form id="uploadForm">
    <label for="file">Upload HTML file</label><br>
    <input id="fileUpload" name="fileUpload" type="file" /><br>
    <label for="file">Or paste HTML table below</label><br>
    <textarea id="manualTable" rows="10" cols="50" placeholder="Paste HTML table here"></textarea><br><br>
    
    <label for="tableClass">Country:</label>
    <input id="country" name="country" type="text" placeholder="Enter country"><br>
    <label for="tableClass">Table class:</label>
    <input id="tableClass" name="tableClass" type="text" placeholder="Enter table class" value="table-charts"><br><br>
    
    <button type="submit">Parse</button>
  </form>

  <h2>Parsed Results</h2>
  <button id="copyButton" onclick="copyResult()">Copy tooo0o clipboard</button>
  <pre><code id="result"></code></pre>

  <script>
    document.getElementById('uploadForm').addEventListener('submit', function(event) {
      event.preventDefault();
    
      const fileInput = document.getElementById('fileUpload');
      const file = fileInput.files[0];
    
      // Get the value of the manualTable textarea
      const manualTable = document.getElementById('manualTable').value.trim();
    
      // Check if the manualTable textarea has content
      if (manualTable) {
        festivalParser(manualTable); // Parse directly from the textarea content
        return; // Exit the function to prevent further processing
      }
    
      const reader = new FileReader();
      reader.onload = function(event) {
        const fileContent = event.target.result;
        festivalParser(fileContent); // Parse the file content
      };
    
      if (!file) {
        alert('Please either paste in a table or upload a file.');
        return;
      }
      reader.readAsText(file); // Read the uploaded file
    });
    
    
    function festivalParser(htmlContent) {
      const festivalParser = new DOMParser();
      const doc = festivalParser.parseFromString(htmlContent, 'text/html');
      const tableClass = document.getElementById('tableClass').value.trim();
      const table = doc.querySelectorAll('table.' + tableClass);
    
      if (!table || table.length === 0) {
        displayResult(`No tables found with class \"${tableClass}\" in the HTML file submitted.`);
        return;
      }
    
      const manualTable = document.getElementById('manualTable').value.trim();
    
      const tableCleaned = document.createElement('table');
      if (manualTable) {
        tableCleaned.innerHTML = manualTable;
      } else {
        tableCleaned.innerHTML = Array.from(table)[1].innerHTML;
      }
    
      const rows = tableCleaned.querySelectorAll('tr');
    
      let results = "";
      let inputCountry = document.getElementById('country').value.trim();
    
      rows.forEach(row => {
        const tdElements = row.querySelectorAll('td');
        let festivalName = "";
        let festivalLocation = "";
        let festivalSize = "";
        let festivalGenre = "";
        let festivalAnalytics = "";
    
        tdElements.forEach((td, index) => {
          switch (index) {
            case 0: // First child <td>
              // Nothing for rank number td
              break;
            case 1: // Second child <td>
              const articleElement = td.querySelector('article');
              if (articleElement) {
                festivalName = articleElement.querySelector('a h3').textContent.trim();
                festivalLocation = articleElement.querySelector('a.location').textContent.trim().replace(`, ${inputCountry}`,"");
                if (inputCountry) {
                  festivalLocation = articleElement.querySelector('a.location').textContent.trim().replace(`, ${inputCountry}`,"");
                } else {
                  festivalLocation = articleElement.querySelector('a.location').textContent.trim();
                }
                festivalAnalytics = articleElement.querySelector('a:first-child').getAttribute('href');
              }
              break;
            case 2: // Third child <td>
              // Nothing for country td
              break;
            case 3: // Fourth child <td>
              festivalGenre = td.querySelector('.genres').textContent.trim();
              break;
            case 4: // Fifth child <td>
              festivalSize = td.querySelector('.value').textContent.trim();
              break;
            case 5: // Sixth child <td>
              // Nothing for performance rank
              break;
            case 6: // Seventh child <td>
              // Nothing for lineup rank
              break;
            case 7: // Eighth child <td>
              // Nothing for network rank
              break;
            default:
              break;
          }
        });
    
        festivalAnalytics = `https://app.viberate.com${festivalAnalytics}`
    
        // Concatenate variables into a string for the current row
        const rowData = `${festivalName};;${festivalLocation};${festivalSize};${festivalGenre};;;${festivalAnalytics}\n`;
        results += rowData;
      });
    
      // Displaying formatted results
      displayResult(results);
    
      // Check if the button already exists before creating and appending a new one
      // if (!document.getElementById('copyButton')) {
      //   // Add a button to copy results to clipboard
      //   //const copyButton = document.createElement('button');
      //   //copyButton.id = 'copyButton';
      //   //copyButton.textContent = 'Copy to Clipboard';
      //   copyButton.addEventListener('click', function() {
      //     copyToClipboard(results);
      //   });
        
      //   // Insert the copy button before the result element
      //   const resultElement = document.getElementById('result');
      //   resultElement.parentNode.insertBefore(copyButton, resultElement);
      // }
    }
    
    function displayResult(result) {
      const resultElement = document.getElementById('result');
      resultElement.textContent = result;
    }
    
    function copyResult() {
      // Get the text field
      var copyText = document.getElementById('result');

      // Select the text field
      //copyText.select();
      //copyText.setSelectionRange(0, 99999); // For mobile devices

      // Copy the text inside the text field
      //navigator.clipboard.writeText(copyText.value);
      navigator.clipboard.writeText("hellow");

      // Alert the copied text
      console.log("copied")
      alert("Copied the text: " + copyText.value);
    }

    // function copyToClipboard(text) {
    //   const textarea = document.createElement('textarea');
    //   textarea.value = text;
    //   document.body.appendChild(textarea);
    //   textarea.select();
    //   document.execCommand('copy');
    //   document.body.removeChild(textarea);
    // }

    // document.getElementById('copyButton').addEventListener('click', function() {
    //   console.log("click")
    //   copyToClipboard(results);
    // });
  </script>
</body>
</html>