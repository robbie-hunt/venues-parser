<!DOCTYPE html>
<html>
<head>
  <title>Music Venue Parser</title>
</head>
<body>
  <h1>Music Venue Information Parser</h1>

  <form id="uploadForm">
    <label for="file">Upload HTML file</label><br>
    <input id="fileUpload" name="fileUpload" type="file" /><br>
    <label for="file">Or paste HTML table below</label><br>
    <textarea id="manualTable" rows="10" cols="50" placeholder="Paste HTML table here"></textarea><br><br>
    
    <label for="tableClass">Country:</label>
    <input id="country" name="country" type="text" placeholder="Enter country" value="New Zealand"><br>
    <label for="tableClass">Table class:</label>
    <input id="tableClass" name="tableClass" type="text" placeholder="Enter table class" value="table-charts"><br><br>
    
    <button type="submit">Parse</button>
  </form>

  <script>
  document.getElementById('uploadForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const fileInput = document.getElementById('fileUpload');
    const file = fileInput.files[0];

    // Get the value of the manualTable textarea
    const manualTable = document.getElementById('manualTable').value.trim();

    // Check if the manualTable textarea has content
    if (manualTable) {
        parseHTMLFile(manualTable); // Parse directly from the textarea content
        return; // Exit the function to prevent further processing
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        const fileContent = event.target.result;
        parseHTMLFile(fileContent); // Parse the file content
    };

    if (!file) {
        alert('Please either paste in a table or upload a file.');
        return;
    }
    reader.readAsText(file); // Read the uploaded file
});


  function parseHTMLFile(htmlContent) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');
    const tableClass = document.getElementById('tableClass').value.trim();
    const table = doc.querySelectorAll('table.' + tableClass);

    if (!table || table.length === 0) {
      displayResult(`No tables found with class \"${tableClass}\" in the HTML file submitted.`);
      return;
    }

    const manualTable = document.getElementById('manualTable').value.trim();

    const tableCleaned = document.createElement('table');
    if (manualTable) {
      tableCleaned.innerHTML = manualTable;
    } else {
      tableCleaned.innerHTML = Array.from(table)[1].innerHTML;
    }

    const rows = tableCleaned.querySelectorAll('tr');

    let results = "";
    let inputCountry = document.getElementById('country').value.trim();

    rows.forEach(row => {
      const tdElements = row.querySelectorAll('td');
      let venueName = "";
      let venueLocation = "";
      let venueType = "";
      let venueCapacity = "";
      let venueGenre = "";
      let venueAnalytics = "";

      tdElements.forEach((td, index) => {
        switch (index) {
          case 0: // First child <td>
            const articleElement = td.querySelector('article');
            if (articleElement) {
              venueName = articleElement.querySelector('a h3').textContent.trim();
              venueLocation = articleElement.querySelector('a.location').textContent.trim().replace(`, ${inputCountry}`,"");
              venueAnalytics = articleElement.querySelector('a:first-child').getAttribute('href');
            }
            break;
          case 1: // Second child <td>
            // Nothing for country td
            break;
          case 2: // Third child <td>
            venueGenre = td.querySelector('.genres').textContent.trim();
            break;
          case 3: // Fourth child <td>
            venueType = td.querySelector('.value').textContent.trim();
            break;
          case 4: // Fifth child <td>
            venueCapacity = td.querySelector('.value').textContent.trim();
            break;
          default:
            break;
        }
      });

      venueAnalytics = `https://app.viberate.com${venueAnalytics}`

      // Concatenate variables into a string for the current row
      const rowData = `${venueName};${venueType};${venueCapacity};${venueLocation};${venueGenre};;;${venueAnalytics}\n`;
      results += rowData;
    });

    // Displaying formatted results
    displayResult(results);
  }

  function displayResult(result) {
    const resultElement = document.getElementById('result');
    resultElement.textContent = result;
  }
  </script>

  <h2>Parsed Results</h2>
  <pre id="result"></pre>
</body>
</html>